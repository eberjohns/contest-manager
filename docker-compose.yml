# version: '3.8'

services:
  # 1. THE MANAGER (Your Backend & Frontend)
  manager:
    build: ./server
    container_name: contest_manager
    ports:
      - "3000:3000"
    environment:
      - PORT=3000
      - JUDGE0_URL=http://judge0:2358
      # The Launcher will eventually inject the PIN here.
      # For now, we default to '1234' for testing.
      - CLASS_PIN=${CLASS_PIN:-1234}
    volumes:
      # This maps the database file to your host machine
      # so you don't lose data if you restart the server.
      - ./data:/app/data
      - ./client:/app/client:ro  # <--- ADD THIS LINE (Maps your local client folder to the container)
      # Note: We map it to /app/client because WORKDIR is /app
    depends_on:
      - judge0

  # 2. THE JUDGE (Code Execution Engine)
  judge0:
    image: judge0/judge0:latest
    container_name: contest_judge
    privileged: true
    ports:
      - "2358:2358"
    environment:
      - REDIS_URL=redis://redis:6379
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_DB=postgres
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
    volumes:
      - ./judge0_conf:/judge0.conf:ro
    depends_on:
      - redis
      - postgres

  # 3. REDIS (Judge0's Queue)
  redis:
    image: redis:alpine
    container_name: contest_redis

  # 4. CLOUDFLARE TUNNEL (Public Access)
  # This creates a temporary public URL every time you run it.
  tunnel:
    image: cloudflare/cloudflared:latest
    container_name: contest_tunnel
    command: tunnel --url http://manager:3000
    depends_on:
      - manager

  postgres:
    image: postgres:13
    container_name: contest_postgres
    environment:
      POSTGRES_DB: postgres
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    volumes:
      - postgres_data:/var/lib/postgresql/data

volumes:
  postgres_data:
